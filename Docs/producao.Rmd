---
title: "Análise Produção (por fazenda)"
author: "Panosso, AR"
date: "2026-01-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  comment = "#>"
)
```

#### Carregando Pacotes
```{r}
library(tidyverse)
library(agricolae)
library(ExpDes.pt)
```

#### Carregando o Banco de dados
```{r}
data_set <- read_rds("../data/data-set-producao.rds")
glimpse(data_set)
```

#### Análise de Variância - com teste de pressupostos

```{r}
names_variable <- data_set |> select(tch_media:tah_media) |> names()
walk(names_variable, ~{
  data_set_aux <- data_set |> 
    select(c(faz:bloco,!!sym(.x))) |> 
    mutate(
      trat = as_factor(trat) 
    ) |> 
    drop_na()
  fazenda <- data_set_aux |> pull(faz) |> unique()
  for(i in seq_along(fazenda)){
    df_aux <- data_set_aux |> 
      filter(faz == fazenda[i])
    y <- df_aux  |> pull(!!sym(.x))
    trat <- df_aux  |> pull(trat)
    bloco <- df_aux  |> pull(bloco)
    mod_dbc <- aov(y ~ trat + bloco)
    print(paste("||======= ANOVA para:",.x,"; Fazenda:",fazenda[i],"=======||"))
    dbc(trat,bloco,y,mcomp = "tukey")
    
    print(paste("||======= REGRESSAO para:",.x,"; Fazenda:",fazenda[i],"=======||"))
    df_aux <- data_set_aux |> 
      filter(faz == fazenda[i],
             dose != 999
             )
    yd <- df_aux  |> pull(!!sym(.x))
    dose <- df_aux  |> pull(dose) |> as.numeric()
    bloco <- df_aux  |> pull(bloco)
    dbc(dose,bloco,yd,quali = FALSE, mcomp = "tukey")
    
    plot_reg <- df_aux |> 
      group_by(dose) |> 
      summarise(
        media = mean(!!sym(.x))
      ) |> 
      ggplot(aes(x = dose, y = media)) +
      geom_point(size = 3) +
      labs(
        y = .x,
        x = "Dose",
      ) +
      theme_minimal()
    print(plot_reg)
    
    print("------Pressuposicao: Normalidade dos residuos")
    rs <- rstudent(mod_dbc)
    print(hist(rs))
    print(shapiro.test(rs))
    print("------Pressuposição: Homogeneidade das variancias")
    plot_boxplot <- df_aux |> 
      ggplot(aes(y=!!sym(.x), x=trat, fill=trat)) + 
      geom_boxplot() +
      theme_bw()
    print(plot_boxplot)
    print(lawstat::levene.test(y,trat,location = "median"))
    
    
  }
})
```
